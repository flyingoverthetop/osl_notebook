{% load i18n %}
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"> 
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-us" xml:lang="en-us" > 
<head> 

<!--TODO:useful?-->
<meta charset="utf-8">

<title>
{% block title %}
{% endblock %}
</title>

 <link rel="stylesheet" type="text/css"  href="/site_media/css/print.css"> 

 <link rel="stylesheet" type="text/css" href="http://ajax.googleapis.com/ajax/libs/jqueryui/1/themes/flick/jquery-ui.css">
<link href="/site_media/css/tag-it/jquery.tagit.css" rel="stylesheet" type="text/css" />


<link rel="stylesheet" type="text/css" href="/media/css/base.css" /> 
<link rel="stylesheet" type="text/css" href="/media/css/dashboard.css" /> 

<link rel="stylesheet" type="text/css" href="/media/css/changelists.css" /> 



<!--[if lte IE 7]><link rel="stylesheet" type="text/css" href="/media/css/ie.css" /><![endif]--> 
<meta name="robots" content="NONE,NOARCHIVE" /> 

<link href="/site_media/css/editableText.css" rel="stylesheet" type="text/css" />	
<link href="/site_media/css/note.css" rel="stylesheet" type="text/css" /> 
<link rel="stylesheet" href="/site_media/css/jquery.jdMenu.css" type="text/css" /> 



	<!-- We will use jQuery hosted by Google-->
	        <!--
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.3.2/jquery.min.js" type="text/javascript"></script>	
    
      <script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.4.0/jquery.min.js"></script>
 
  
       <script src="/site_media/js/jquery-1.4.js" type="text/javascript"></script>	
  -->
 <!--
        <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.4/jquery.min.js" type="text/javascript" charset="utf-8"></script>
 
-->
    <script src="/site_media/js/jquery.min.js" type="text/javascript" charset="utf-8"></script>	



   
    <script src="/site_media/js/jquery.editableText.js" type="text/javascript"></script>
    
     <script src="/site_media/js/jquery.positionBy.js" type="text/javascript"></script>	
     <script src="/site_media/js/jquery.dimensions.js" type="text/javascript"></script>	
     
     <script src="/site_media/js/jquery.bgiframe.js" type="text/javascript"></script> 
	<script src="/site_media/js/jquery.jdMenu.js" type="text/javascript"></script> 
    

	<script src="/site_media/js/chili-1.7.pack.js"  type="text/javascript" ></script>	
	<script src="/site_media/js/jquery.easing.js"  type="text/javascript" ></script>
    <!--
	<script src="/site_media/js/jquery.accordion.js"  type="text/javascript" ></script>
    -->
    <script src="/site_media/js/jquery.AddIncSearch.js"  type="text/javascript" ></script>

	
  <!--    
    <link href="/site_media/css/tag-it/reset.css" rel="stylesheet" type="text/css" />
 
	<link href="/site_media/css/tag-it/master.css" rel="stylesheet" type="text/css" />
    -->
    
        <script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.8.12/jquery-ui.min.js" type="text/javascript" charset="utf-8"></script>
 <!--
	<link href="/site_media/css/jquery-ui/jquery.ui.autocomplete.custom.css" rel="stylesheet" type="text/css"  />
    <script src="/site_media/js/jquery-ui/jquery-ui-1.8.core-and-interactions.min.js" type="text/javascript" charset="utf-8"></script>
	<script src="/site_media/js/jquery-ui/jquery-ui-1.8.autocomplete.min.js" type="text/javascript" charset="utf-8"></script>
       -->
	<script src="/site_media/js/tag-it.js" type="text/javascript" charset="utf-8"></script>


    
    
    
{% block extra_css %}
{% endblock %}

{% block extra_script %}
{% endblock %}



    
<script type="text/javascript">
	//disalbe print.css
    document.getElementsByTagName('link')[0].disabled = true;
     function print(){		
            document.getElementsByTagName('link')[0].disabled = false;
            $('#back_icon').show();
          $( "#sortable" ).sortable( "option", "disabled", true);
            };
            
      function back_from_print(){		
            document.getElementsByTagName('link')[0].disabled = true;
             $('#back_icon').hide();
            $( "#sortable" ).sortable( "option", "disabled", false);
            };      
    
    
	Array.prototype.unique = function () {
	var r = new Array();
	o:for(var i = 0, n = this.length; i < n; i++)
	{
		for(var x = 0, y = r.length; x < y; x++)
		{
			if(r[x]==this[i])
			{
				continue o;
			}
		}
		r[r.length] = this[i];
	}
	return r;
}

    function sortNumber(a,b){
            return a - b;
    }
	
    
       function addNote(){              
            desc = $('#id_desc').val();         
            //alert('desc:'+desc);             
            priv = $('#id_private').attr('checked');
          //   alert('priv:'+priv);           
           
            var selected_tags = [];	
            $('ul#add_note_tags').find('li.tagit-choice').each(function(){               
                   	   // alert('find a tag:'+$(this).find(':input').val());
                            selected_tags.push($(this).find(':input').val());	                  			
            });	
             
           //$.post('/{{profile_username}}/{{bookname}}/notes/addNote/',{'desc':desc, 'private':priv,'tags':selected_tags}, noteAdded, 'json');         
          $.post('/{{profile_username}}/{{bookname}}/notes/addNote/?desc='+encodeURIComponent(desc)+'&private='+priv+'&tags='+selected_tags,{}, noteAdded, 'json');         
               
                        
    } 
    
     function noteAdded(note){
       // TODO: how to show error when error happened?      
        //   $('ul.messages').append('<li class="error">{% trans "An error happened when adding a note." %} </li>');     
        $('ul.messages').append('<li class="success">{% trans "Note is successfully added!" %} </li>');
       
        pri_part = ""
        if (note.private==true){
            pri_part =  '<span class="lock" title="{% trans "private"  %}" style="display:inline;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>' +'<span class="unlock" title="{% trans "public"  %}" style="display:none;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>'
        }else{
           pri_part =  '<span class="unlock" title="{% trans "public"  %}" style="display:inline;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>'+'<span class="lock" title="{% trans "private"  %}" style="display:none;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>'
        }
        tags = '';
        tags_in_full = '';
        for (var i=0;i<note.tags.length;i++){
            tags = tags +  '<span><a href="/{{profile_username}}/{{bookname}}/notes/tags/'+note.tags[i]+'/">'+note.tags[i]+'</a>,</span>';
            tags_in_full = tags_in_full + '<li>'+note.tags[i]+'</li>';
        }
        
        
        
        comments = ''
         for (var i=0;i<note.comments.length;i++){               
                     comments=comments+'<div comment_id="'+note.comments[i].id+'">'+note.comments[i].desc+'<span title="{% trans "remove this comment" %}" class="inline_delete_comment" id="note_delete_comment">&nbsp;&nbsp;&nbsp;</span></div>';                      
      }
        
    //    alert('tags:'+tags);
        toprepend = '<li class="note_display" note_id="'+note.note_id+'"><input type="checkbox" name="note_selected"  value="'+
                      note.note_id+'" class="note_selection" /><div class="kuoda"></div><div class="yasuo"></div> <span class="lockunlock">'+pri_part+'</span>'+
                               
                      '<span class="thumb"><span class="thumbup hover"  title="{% trans "Rank Up Importance"  %}"><img src="/site_media/img/thumbUp.gif"/></span>'+
			                                                 '<span class="thumbdown hover"  title="{% trans "Rank Down Importance"  %}"><img src="/site_media/img/thumbDown.gif"/></span>'+
                      '<span id="note_rank" title="{% trans "Importance"  %}">'+note.vote+'</span></span><span class="delete_img hover" title="{% trans "soft delete" %}"><img src="/site_media/img/delete.png"/></span>'+
                      '<div class="snippetbook"><div class="brief_display"><table class="note_table"><tr><td class="note_table_td1 structure"><div id="note_title" title="{% trans "note title" %}">'+
                      '<a href="/{{profile_username}}/{{bookname}}/notes/note/'+note.note_id +'/">{% trans "(No Title)" %}</a></div> </td><td class="note_table_td2"><div  id="note_desc" title="{% trans "note desc" %}">'+note.desc+'</div>'+	
                      '</td> <td class="note_table_tags">  <div id="note_tags" title="{% trans "note tags" %}">'+tags+'</div></td> <td class="note_table_td4">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</td></tr></table></div>'+
                      '<div class="full_display">'+
                                '<table class="note_table"><tr><td class="note_table_td1 structure">'+
                                       '<div id="note_title" title="{% trans "note title" %}"><span class="editableText"><a href="/{{profile_username}}/{{bookname}}/notes/note/'+note.note_id+'/">{% trans "(No Title)" %}</a></span></div></td><td class="note_table_td2"> '+	
                                       '<div  id="note_desc" title="{% trans "note desc" %}"><span class="editableText">'+note.desc+'</span></div></td><td class="note_table_tags">'+
                                       '<span class="editable"><span class="tags_edit">&nbsp;&nbsp;&nbsp;&nbsp;</span>'+
                                       '<div id="update_tags_inline_box" style="display: none;"  title="{% trans "note tags" %}">'+
                                                '<ul id="update_tags_inline">'+tags_in_full+'</ul>'+
                                        '</div>'+
                                         '<span class="tags_text">'+note.display_tags+'</span></span>' +                                       
                                                     
                                       
                                      // '<div id="note_tags" title="{% trans "note tags" %}"><span class="editableText">'+note.display_tags+'</span></div> '
                                      '</td></tr></table>'+
                                       //time and comments
                                       ' <div>'+
                                            '<div  class="grey" id="note_init_date" title="{% trans "initial creation time" %}"><span  class="editableText">'+note.init_date+'<span></div>'+
                                            '<div class="grey structure" id="note_last_modi_date" title="{% trans "last modified time" %}">'+note.last_modi_date+'</div>'+
                                            '<div  class="structure advanced" id="note_frames" title="{% trans "note in frames" %}">{% trans "Frames" %}: {{note.display_frames|default:_("Not in any frame")}}</div>'+                              
                                         //comments
                                            '<span class="add_comment_button"><a href="javascript:void(0);">{% trans "Comment" %}(0)</a></span>'+
                                                ' &nbsp;&nbsp;'+
                                            '<div  id="add_comment_box" style="display:none;"> '+            
                                                        '<div>{{user.username}}: <textarea id="add_comment" rows="3" cols="90" name="desc"></textarea>'+
                                                                '<span class="comment_submit"  title="{% trans "Save Comment" %}"><img src="/site_media/img/save.png"/></span>&nbsp;'+
                                                                '<span class="cancel_comment_submit" title="{% trans "Cancel" %}"><img src="/site_media/img/cancel.png" /></span>'+
                                                        '</div>'+             
                                                        '<div id="comments"><br/>'+ 
                                                                    comments+
                                                        '</div>'+             
                                            '</div>'+                                           
                                        '</div>'+
                       '</div></div></div>'+                
                                       
                      '</li>';
     //      alert('toprepend:'+toprepend);         
        $('div.notes_display').find('ul.notes_display').prepend(toprepend);
        
        //clear the form's desc textarea field
        $('#id_desc').val('');
        

        
        //TODO: duplicated, merge 
          $('li.note_display').mouseenter(function(){	    
                        $(this).find('.hover').show();
                        
                });
                
           $('li.note_display').mouseleave(function(){	    
                        $(this).find('.hover').hide();
                        
                });     
                
                  $("li[note_id='"+note.note_id+"']  .stream").show();    
                  $("li[note_id='"+note.note_id+"']  .structure").hide();
            
            
              $("li[note_id='"+note.note_id+"']  div.brief_display").show();
              $("li[note_id='"+note.note_id+"']  div.full_display").hide();	
            
             $("li[note_id='"+note.note_id+"']  .yasuo").hide();
		
          $('.kuoda').click(function(){		
                    $(this).parents("li").find('div.brief_display').hide(100);
                    $(this).parents("li").find('div.full_display').show(100);
                
                    $(this).parents("li").find("div.kuoda").hide(100);
                    $(this).parents("li").find("div.yasuo").show(100);		
            });
		
            $('.yasuo').click(function(){        
                    $(this).parents("li").find('div.brief_display').show(100);
                    $(this).parents("li").find('div.full_display').hide(100);		       
                    $(this).parents("li").find("div.kuoda").show(100);
                    $(this).parents("li").find("div.yasuo").hide(100);		
            });		        
        
        
                $("li[note_id='"+note.note_id+"']").find('span.editableText').editableText({
                        newlinesEnabled: false
                });
			
            //    $.editableText.defaults.newlinesEnabled = true;

                //$("li[note_id='"+note.note_id+"']").find('div.editableText, p.editableText').editableText();
	
                $("li[note_id='"+note.note_id+"'] .editableText").change(function(){
                        var newValue = $(this).text();
                        $(this).load('updateNoteInline/',{ 'id':$(this).parents('li').attr('note_id'), 'note_field':$(this).parents('div').attr('id'), 'content':  newValue})
                });
			
                //move below to a separate file
               $("li[note_id='"+note.note_id+"']  .thumbup"). click(function(){                      
                        $(this).parents(".thumb").find("#note_rank").load('voteUpNote/',{ 'id':$(this).parents("li").attr('note_id')});
                });
		
                   $("li[note_id='"+note.note_id+"']  .thumbdown"). click(function(){
                        $(this).parents(".thumb").find("#note_rank").load('voteDownNote/',{ 'id':$(this).parents("li").attr('note_id')});
                });
		
                  $("li[note_id='"+note.note_id+"'] .delete_img"). click(function(){
                        $(this).load('deleteNote/',{ 'id':$(this).parents("li").attr('note_id')});
                        $(this).parents("li").remove();
                });


  
                
        
        
           $("li[note_id='"+note.note_id+"'] .comment_submit").click(function(){  
                        var newValue = $(this).parents("#add_comment_box").find("#add_comment").val();
                        $.post('addComment/',{ 'id':$(this).parents('li').attr('note_id'), 'content':  newValue}, commentAdded ,'json');              
      
                });
                
                 $("li[note_id='"+note.note_id+"'] .cancel_comment_submit").click(function(){                   
                        comment_box  = $(this).parents("#add_comment_box")
                        comment_box.find("#add_comment").val('');
                        comment_box.hide();
      
                });
                
               
                //TODO:totoally the same as the one in the main. Just call it?
                function commentAdded(result){
                        note_id = result.note_id;
                     //$("li[note_id='"+note_id+"']").find('div#comments').append("<div>"+result.content+"</div>");   
                     
                      $("li[note_id='"+note_id+"']").find('div#comments').prepend('<div comment_id="'+result.comment_id+'">{% block new_note_comment_display  %}'+result.comment_desc+
                                                                      '{% endblock %}<span title="{% trans "remove this comment" %}" class="inline_delete_comment" id="note_delete_comment">&nbsp;&nbsp;&nbsp;</span></div>');   
                   
                    $("li[note_id='"+note_id+"']").find('div#comments').find("div[comment_id='"+result.comment_id+"']").find('span.inline_delete_comment').click(function(){	                
                        $(this).load('deleteComment/',{'comment_id':$(this).parents('div').attr('comment_id')});
                        $(this).parents("div[comment_id]").remove();
                   });
                     
                     
                    comment_box = $("li[note_id='"+note_id+"']").find('div#add_comment_box');
                    comment_box.find("#add_comment").val('')
                    //comment_box.hide();
                
                }
                
                
                  $("li[note_id='"+note.note_id+"'] .add_comment_button").click(function(){                   
                        $(this).parents('li').find('#add_comment_box').show();               
      
                });
                
                
                  $("li[note_id='"+note.note_id+"'] span.inline_delete_comment").click(function(){	                
                    $(this).load('deleteComment/',{'comment_id':$(this).parents('div').attr('comment_id')});
                    $(this).parents("div[comment_id]").remove();
                });
                
        
                            
                  $("li[note_id='"+note.note_id+"']  span.unlock").click(function(){	                   
                    $.post('makePrivate/',{'id':$(this).parents('li').attr('note_id')}, privacyChanged, 'json');                   
                });
                
                  $("li[note_id='"+note.note_id+"']  span.lock").click(function(){	                   
                    $.post('makePublic/',{'id':$(this).parents('li').attr('note_id')}, privacyChanged, 'json');                   
                });
                
                
                  function privacyChanged(result){                 
                    note_id = result.note_id
                    if (result.private == 'y'){
                    //alert('is true');                          
                          $("li[note_id='"+note_id+"']").find('span.lock').show();
                          $("li[note_id='"+note_id+"']").find('span.unlock').hide();
                    }else{
                   //alert('is fale');
                          $("li[note_id='"+note_id+"']").find('span.unlock').show();
                          $("li[note_id='"+note_id+"']").find('span.lock').hide();
                    }
                }
                
               

                     

                
            $("li[note_id='"+note.note_id+"']  span.tags_edit"). click(function(){
                //alert('tags edit clicked');
                      var  editable =    $(this).parents('span.editable') ; 
                       editable.find('span.tags_text').hide();
                       //TODO: think of if better to move below into the html code and use show/hide instead of spitting out from js on the fly and remove later. Also the functions defined here can be moved out.
                        editable.prepend('<span class="tags_save">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="tags_cancel">&nbsp;&nbsp;&nbsp;&nbsp;</span>');                        
                        editable.find("#update_tags_inline_box").show();
                        
                        editable.find("#update_tags_inline").tagit({
			              availableTags: tagsAvailable,
                              allowSpaces: true,
                              
                         }); 
                         
                         $(this).hide();
                         
                         
                          $("li[note_id='"+note.note_id+"']  span.tags_cancel"). click(function(){     
                                var  editable =    $(this).parents('span.editable') ;                      
                                editable.find("#update_tags_inline_box").hide();                    
                                editable.find('span.tags_save').remove();
                                editable.find('span.tags_edit').show();
                                editable.find('span.tags_text').show();
                                $(this).remove();
                                
                                 }); 
                         
                         $("li[note_id='"+note.note_id+"']  span.tags_save"). click(function(){                  
                                 var selected_tags = [];	
                                 var  editable =    $(this).parents('span.editable') ;  
                                 editable.find('li.tagit-choice').each(function(){                      	                    
                                            // selected_tags = selected_tags+$(this).find(':input').val()+',';	   
                                            selected_tags.push($(this).find(':input').val());	                            
                                });	                        
                                selected_tags_str =  selected_tags.join();                            
                                $.post('updateNoteTagsInline/',{ 'id':$(this).parents('li').attr('note_id'), 'tags':  selected_tags_str}, tags_updated_inline ,'json');                  
                                //$(this).load('updateNoteInline/',{ 'id':$(this).parents('li').attr('note_id'),'note_field':'note_tags', 'content':  selected_tags_str});
                                
                                
                    
                    
                        });
                     
                     
                     function tags_updated_inline(result){          
                            var  editable =     $('li[note_id="'+result.note_id+'"] span.editable') ;              
                            editable.find('span.tags_cancel').remove();
                            //TODO:define variable with jquery
                            editable.find("#update_tags_inline_box").hide();                    
                            editable.find('span.tags_save').remove();
                            editable.find('span.tags_edit').show();
                            $('li[note_id='+result.note_id+'] span.tags_text').text(result.display_tags);
                            $('li[note_id='+result.note_id+'] span.tags_text').show();
                            toappend = ''
                            for (var i=0;i<result.note_tags.length;i++){ 
                                 toappend = toappend+ '<span><a href="/{{profile_username}}/{{bookname}}/notes/tags/'+result.note_tags[i]+'/">'+result.note_tags[i]+'</a>,</span>';
                            }                            
                            $('li[note_id='+result.note_id+']  div.brief_display  div#note_tags').empty().append(toappend);
                            
                    }                   
                         
                  
        });
                

        
    }
    
    
    function showAddTags(){    
            //alert('show add tgs');
            $('#ac_tags_box').show(3);  
             $('#add_tags_to_notes').show(3); 
            $('#remove_tags_from_notes').hide(3);                
           //$('#ac_tags_box  li.tagit-new input').focus();   //commented out because in chrome it will cause the enterred tag shifted upwards . Not sure it is ok in showAddNoteTags
           //$('#ac_tags_box').css("background-color","#F5FC9E");//not working for now. It is probably better without it.
            
        //alert('the tags in the widgit:'+  $("#ac_tags").tagit("assignedTags"));
           
           // $('#ac_tags').css("border","groove");
                        
    }
    
    
    
    function cancelChangeTags(){    
            //alert('cancel add tgs');
            $('#ac_tags_box').hide(0);  
            //Below cannot succesfully remove tags entered earlier. I guess it is ok to leave those tags there for now
            //$('ul#ac_tags').text('')
    }
    
    function showRemoveTags(){    
            //alert('show remove tgs');
            $('#ac_tags_box').show();  
            $('#remove_tags_from_notes').show();   
            $('#add_tags_to_notes').hide();     
            $('.tagit-input').focus();     
            $('.tagit-input').css("background-color","#F5FC9E");            
    }

	
	function	addTags(){    
		    var selected_tags = [];    		    
		    $('.tag_selection').each(function(){
                    if ($(this).attr('checked')==true){			
                        selected_tags.push($(this).val());	
                    }			
		     });
             
            selected_notes = getSelectedNoteIds();		       
		    
		       
		      // $(this).load('addTags2Notes/', {'note_ids': selected_notes, 'tags_to_add': selected_tags}, processReturn);
		       
               //window.location.href=window.location.href;
		      //setTimeout( "window.location.reload(false)", 1000) ; //TODO: only load the changed notes using response from the server
		       //time out is added to fix a problem happened after uplodading to the server. If wait a while, the ajax will succeed, otherwise, will return error.
               //on local server, tags will be added or removed even return error. But on remote server, the py method is not even called.
               //On local server, no the pipe broken error any more.
               //So I think the reason is like this: this ajax call is a non-blocking one. So if you reload the page, the pipe is broken. On a local server, the ajax call is already
              //mapped to a url and method called. But for a remote server, the ajax call probably fall behind the next page reload request and is not even mapped to a url yet.         
               
               
            $.ajax({url: 'addTags2Notes/'+
                                    '?note_ids='+selected_notes+
                                    '&tags_to_add='+selected_tags,
                            success:  processReturn,
                            async:   false
            })
            
          
            
            window.location.reload(false);     
		       //return true;
		
	}
    
    function processReturn(data){
         ;    
    }
    
    
    function  addTags_new(){
    //alert('adding tags new...');
          var selected_tags = [];	
         
            $('ul#ac_tags').find('li.tagit-choice').each(function(){               
                   	   // alert('find a tag:'+$(this).find(':input').val());
                            selected_tags.push($(this).find(':input').val());	
                    			
		     });	
          // alert('selected_tags is:'+selected_tags );        
           
            selected_notes = getSelectedNoteIds();		 
           
           if (selected_notes == ""){
               alert('{% trans "Please select the notes!" %}');
               return ;
            }
              $.post('addTags2Notes2/'+
                                    '?note_ids='+selected_notes+
                                    '&tags_to_add='+selected_tags, {},
                          tagsChanged, 'json');
           
    }
	
	function removeTags(){
            var selected_tags = [];		    
		    $('.tag_selection').each(function(){
                    if ($(this).attr('checked')==true){				
                            selected_tags.push($(this).val());	
                    }			
		     });		    
		      
            selected_notes = getSelectedNoteIds();	    
		       
		       //$(this).load('removeTagsFromNotes/', {'note_ids': selected_notes, 'tags_to_add': selected_tags}, processReturn);
		       
               //window.location.href=window.location.href;
		     // setTimeout( "window.location.reload(false)", 1000);
		       //return true;
               
               
            $.ajax({url: 'removeTagsFromNotes/'+
                                    '?note_ids='+selected_notes+
                                    '&tags_to_add='+selected_tags,
                            success:  processReturn,
                            async:   false
            })
                           
            window.location.reload(false);    
	
	}
    
    
    function removeTags_new(){
          
          var selected_tags = [];	
          $('ul#ac_tags').find('li.tagit-choice').each(function(){               
                   	    //alert('find a tag:'+$(this).find(':input').val());
                            selected_tags.push($(this).find(':input').val());	
                    			
		     });	
           //alert('selected_tags is:'+selected_tags );        
           
            selected_notes = getSelectedNoteIds();		  
            if (selected_notes == ""){
               alert('{% trans "Please select the notes!" %}');
               return ;
            }
              $.post('removeTagsFromNotes2/'+
                                    '?note_ids='+selected_notes+
                                    '&tags_to_add='+selected_tags,
                            {}, tagsChanged, 'json');
            //window.location.reload(false);     
            //return false;
    
    
    
    }
    
    function tagsChanged(result){ 
//clear the tags for next input    
$("#ac_tags").tagit("removeAll");
         $('#ac_tags_box').hide();    
           //$('ul.messages').empty();//TODO:set timeout for message displayed? Like how gmail does
         $('ul.messages').append('<li class="success">{% trans "Tags are successfully updated!" %} </li>');
        for (var i=0; i < result.length; i++){
            toappend = ""        
            for (var j=0; j < (result[i][1]).length; j++){
                toappend = toappend+'<span><a href="/{{profile_username}}/{{bookname}}/notes/tags/'+result[i][1][j]+'/">'+result[i][1][j]+'</a>,</span>'
            }        
           $("li[note_id='"+result[i][0]+"']").find('div.brief_display').find('div#note_tags').empty().append(toappend);
           $("li[note_id='"+result[i][0]+"']").find('div.full_display').find('div#note_tags').find('span').empty().append(result[i][2]);
        }    
    }
		 
	
			
    function	linkNotes(){
		     selected_notes = getSelectedNoteIds();
		     $('form#linkNotesForm').before("{% trans 'The following notes are going to be put into a frame:' %}"+selected_notes);
		     $('form#linkNotesForm').prepend('<input type="hidden"  name="notes"  value="'+selected_notes+'"/>');
		     $('.linkNotes').show();		
    }
		
		
    function	showSelectedPlusCachedNoteIds(){
		     notes = getSelectedPlusCachedNoteIds();
		     alert("Selected notes:"+ notes+"  You can copy and paste these ids into another form.");			
    }
		
    function	getSelectedPlusCachedNoteIds(){
		     current_selected_notes = getSelectedNoteIds();
		     cached_notes = getCachedNoteIds();
		     //alert('cached_notes:'+cached_notes);
		     notes = current_selected_notes +','+cached_notes ;
		     notes_list = notes.split(',');
		     //alert('selected_notes_list :'+selected_notes_list );		     
		     notes_set = notes_list.unique();
		     notes_set.sort(sortNumber);		     
		     //alert('selected_notes_set :'+selected_notes_set );
		     unique_notes = notes_set.toString();
		     return unique_notes;
		
    }
		
    function	showSelectedNotes(){
		      notes = getSelectedPlusCachedNoteIds();
		      $.post('toggleAddNoteMode/', {'addnote_mode':'on'});
		      return false;	
    }
		
		
    function	getCachedNoteIds(){
		       cachespan = $('#cache span');
		       cached_notes= $(cachespan).text();
		       if  (cached_notes=='no notes in cache'){
		             cached_notes ='';
		       }
		       //alert('cached_notes:'+cached_notes);
		       return cached_notes;
    }
		
    function	getSelectedNoteIds(){		    	   
		    var selected_notes = [];	
		    $('.note_selection').each(function(){
                    if ($(this).attr('checked')==true){				
                        selected_notes.push($(this).val());	
                    }			
		     });		     	
		     return selected_notes;
    }
		
    function  selectAll(){
		     $('.note_selection').attr('checked',true);
		
    }
		
    function  selectNone(){		     
		     $('.note_selection').attr('checked',false);		
    }
		
    function addNotes2Cache(cache_id){		   
            selected_notes = getSelectedNoteIds();
            //cachespan = $('span#cache_'+cache_id);		       
            $.post('/{{profile_username}}/{{bookname}}/caches/'+cache_id+'/addNotes2Cache/',{'cache_id':cache_id, 'selected_note_ids':selected_notes}, notesAdded, 'json');
    }		
		
    function notesAdded(cache){			 
            if (cache.created==true){
                    window.location.reload( false ); //for now, just refresh the page. Because the new item added to note menu cannot be clicked. (might because it is not recognized by the jd_menu plugin) TODO:
		  
                    $('div#cache').prepend('<div class="cache_item"><span id="cache_'+cache.cache_id+'">{% trans 'cache' %} ' +cache.cache_id+':' +cache.note_ids+'</span> &nbsp;&nbsp;&nbsp;<a href="/{{profile_username}}/{{bookname}}/caches/'+cache.cache_id+'/">{% trans 'View' %}</a> | <a href="javascript:clearCache('+cache.cache_id+');">{% trans 'Clear' %}</a>');		 
                    previous_cache_id = cache.cache_id-1;
                    next_cache_id = parseInt(cache.cache_id)+1;
                    //alert('<li  id="add_to_cache_'+cache.id+'"><a href="javascript:addNotes2Cache('+cache.id+');">Add selection to cache '+cache.id+'</a></li>');
                    $("li#add_to_cache_"+previous_cache_id).after('<li  id="add_to_cache_'+cache.cache_id+'"><a href="javascript:addNotes2Cache('+cache.cache_id+');">{% trans "Add selection to cache" %}'+cache.cache_id+'</a></li>' );
                    $("li#add_to_another_cache").find('a').attr('href','javascript:addNotes2Cache('+next_cache_id+');')
                    //even after adding below, it still cannot recognize the newly added li 
                 //  $('ul.jd_menu  li[id="add_to_cache_'+cache.cache_id+'"]').jdMenu(); 
// $('ul.jd_menu'). jdMenu();                  

           }
            if (cache.created==false){
                    $('span#cache_'+cache.cache_id).text("{% trans 'cache' %} " +cache.cache_id+":" +cache.note_ids);		 
            }		
            
             $('ul.jd_menu'). jdMenu();       
    }
		
    function clearCache(cache_id){	
            cachespan = $('span#cache_'+cache.cache_id);			
            div = $(cachespan).parents('div.cache_item');			
            $.post('/{{profile_username}}/{{bookname}}/caches/'+cache_id+'/'+'clearCache/', cacheCleared);			 
    }
		
		
		
    function cacheCleared(cache_id){		
            window.location.reload( false ); //for now, just refresh the page TODO:		 
            $('span#cache_'+cache_id).parents('div.cache_item').remove();		  
            $("li#add_to_cache_"+cache_id).remove();
            //TODO: if the last cache, should get rid of add to another, and restore add to the cache 1  		
    }
        
        
    function set_notes_private(){
             selected_notes = getSelectedNoteIds();
             $.post('/{{profile_username}}/{{bookname}}/setNotesPrivate/',{'note_ids':selected_notes},  set_notes_private_callback, 'json');
             //TODO: maybe no reload
            // window.location.reload( true);   
    }
    
    function  set_notes_private_callback(note_ids){                 
                    for (var i=0;i<note_ids.length;i++){
                          $("li[note_id='"+note_ids[i]+"']").find('span.lock').show();
                          $("li[note_id='"+note_ids[i]+"']").find('span.unlock').hide();          
                    }
    }
    
    
    function set_notes_public(){
             selected_notes = getSelectedNoteIds();
             $.post('/{{profile_username}}/{{bookname}}/setNotesPublic/',{'note_ids':selected_notes}, set_notes_public_callback, 'json');   
             //window.location.reload( true);               
         
    }
    
    function set_notes_public_callback(note_ids){                  
                    for (var i=0;i<note_ids.length;i++){
                          $("li[note_id='"+note_ids[i]+"']").find('span.lock').hide();
                          $("li[note_id='"+note_ids[i]+"']").find('span.unlock').show();          
                    }
    }
    
    

     
       
        
    function expandall(){       
              $('div.brief_display').hide();
              $('div.full_display').show();   
              $("div.kuoda").hide();
              $("div.yasuo").show();              
    }
        
    function collapseall(){
            $('div.brief_display').show();
            $('div.full_display').hide();
            $("div.kuoda").show();
            $("div.yasuo").hide(); 
    }
    
    
        
                    
                    
    
    
    //TODO: the ones in base2.html are not updated with the change here.
    function structure(){
              $('.structure').show();
              //$('.stream').hide();
    
            {% ifequal request.session.advanced 'on' %}                       
                    $('.advanced').show();                  
		    {% else %}                   
                    $('.advanced').hide();                   
		    {% endifequal %}     
    }
    
    function stream(){
   
          //$('.stream').show();    
          $('.structure').hide();
    }
    
    
    function show_confirm(){
        var r=confirm("{% trans "If you join this group, any note you make that is tagged with any of the tag of this group will be pushed to this group. Private note, however, will not be pushed, unless you specifically want to share it with a group." %}");
        if (r==true){
            window.location.replace('/groups/{{group.name}}/joinGroup')
        }
        else{
             ;
        }
    }
    
    
function showAddNoteTags(){    
            //alert('show add tgs');
            $("#add_note_tags").tagit("removeAll");
           $('#add_note_tags_box').toggle();  
            $('#add_note_tags').show();  
          //   $('#add_tags_to_note').show(3); 
            $('#add_note_tags_box').find('.tagit-new input').focus();     
           // $('#add_note_tags_box').find('.tagit-new input').css("background-color","#05FC9E");
           
           // $('#ac_tags').css("border","groove");
                        
    }
    
      function  addNoteTags(){
   
           $('#add_note_tags_box').hide();  
    }

        

	
</script>
	
<script type="text/javascript">
	$(document).ready(function(){	
    
        
             $('.share_button').click(function(){	
                //selected_notes = getSelectedNoteIds();
                //$.post('/{{profile_username}}/{{bookname}}/share/',{'note_ids':selected_notes}, shared, 'json');
                $.post('/social/{{bookname}}/share/',{'note_ids':$(this).parents('div').attr('note_id')}, shared, 'json');
     
           });
           
            function shared(result){      
                if (result.count_of_sites==0){
                        alert('You have not set up sites for sharing. Please set it up in the settings.');
                }
                else{           
                        alert(result.count_of_notes+' notes are shared with '+ result.count_of_sites+' sites! You can change sites for sharing in the settings. ');
                }
		
      }

    

          $('li.note_display').mouseenter(function(){	    
                        $(this).find('.hover').show();
                        
                });
                
           $('li.note_display').mouseleave(function(){	    
                        $(this).find('.hover').hide();
                        
                });     
    
    
            $('#ac_tags_box').hide();
           
    
            $('.stream').show();    
            $('.structure').hide();
            
            $('.show_tags_section').show();
            $('.hide_tags_section').hide();
            $('.tag_menu_box').hide();
            
            $('.show_side_menu').hide();
            $('.hide_side_menu').click(function(){	  
                        
                $('.show_side_menu').show();
                $('.hide_side_menu').hide();
                $('#content-related').hide();
                if (screen.availWidth > 1300){           
                    $('#main').css({'width':'1120px'});
                    $('.note_table td.note_table_td1').css({'width': '14em'});
                    $('.note_table td.note_table_td2').css({'width': '30em'});
                    $('.note_table td.note_table_tags').css({'width': '50em'});
                    $('.snippetbook .brief_display #note_desc').css({'width': '63em'});
                    $('.bookmarkbook .brief_display #note_title').css({'width': '33em'});
                    $('.bookmarkbook .brief_display #note_url').css({'width': '30em'});
                    $('.scrapbook .brief_display #note_url').css({'width': '14em'});
                    $('.scrapbook .brief_display #note_desc').css({'width': '50em'});
                }else{
                    $('#main').css({'width':'970px'});
                    $('.note_table td.note_table_td1').css({'width': '12em'});
                    $('.note_table td.note_table_td2').css({'width': '27em'});
                    $('.note_table td.note_table_tags').css({'width': '40em'});
                    $('.snippetbook .brief_display #note_desc').css({'width': '45em'});
                    $('.bookmarkbook .brief_display #note_title').css({'width': '28em'});
                    $('.bookmarkbook .brief_display #note_url').css({'width': '27em'});
                    $('.scrapbook .brief_display #note_url').css({'width': '14em'});
                    $('.scrapbook .brief_display #note_desc').css({'width': '43em'});
              
              }
                         
                });
                
            $('.show_side_menu').click(function(){	               
                    $('.show_side_menu').hide();
                    $('.hide_side_menu').show();
                    $('#content-related').show();
                    if (screen.availWidth > 1300){           
                        $('#main').css({'width':'897px'});
                        $('.note_table td.note_table_td1').css({'width': '14em'});
                        $('.note_table td.note_table_td2').css({'width': '25em'});
                        $('.note_table td.note_table_tags').css({'width': '40em'});
                        $('.snippetbook .brief_display #note_desc').css({'width': '50em'});
                        $('.bookmarkbook .brief_display #note_title').css({'width': '22em'});
                        $('.bookmarkbook .brief_display #note_url').css({'width': '25em'});
                        $('.scrapbook .brief_display #note_url').css({'width': '15em'});
                        $('.scrapbook .brief_display #note_desc').css({'width': '35em'});
                    }else{
                        $('#main').css({'width':'745px'});
                        $('.note_table td.note_table_td1').css({'width': '14em'});
                        $('.note_table td.note_table_td2').css({'width': '23em'});
                        $('.note_table td.note_table_tags').css({'width': '30em'});
                        $('.snippetbook .brief_display #note_desc').css({'width': '35em'});
                        $('.bookmarkbook .brief_display #note_title').css({'width': '18em'});
                        $('.bookmarkbook .brief_display #note_url').css({'width': '22em'});
                        $('.scrapbook .brief_display #note_url').css({'width': '14em'});
                        $('.scrapbook .brief_display #note_desc').css({'width': '26em'});
              
              }
                          
                          
                });
             
            $('.hide_tags_section').click(function(){	  
                        
                        $('.show_tags_section').show();
                        $('.hide_tags_section').hide();
                         $('.tag_menu_box').hide();
                });
                
            $('.show_tags_section').click(function(){	    
                        $('.show_tags_section').hide();
                        $('.hide_tags_section').show();
                         $('.tag_menu_box').show();
                });
    

	
            $('#id_folder_name').hide();
            $('#submit_saveSearch').hide();
            $('#show_folder_name_input').click(function(){
                    $('#id_folder_name').show();
                    $('#submit_saveSearch').show();
                    $(this).hide();
            });
            
            {% ifequal request.session.advanced 'on' %}                       
                    $('.advanced').show();
                    $('.stream').show();    
                    $('.structure').hide();
		    {% else %}                   
                    $('.advanced').hide();                   
		    {% endifequal %}
	
	
            {% ifequal addnote_mode 'on' %}	             
                    $('.show_add_note_section').hide();
                    $('.hide_add_note_section').show();
                    $('.addnote').show();				
		    {% else %}
                    $('.show_add_note_section').show();
                    $('.hide_add_note_section').hide();
                    $('.addnote').hide();
		    {% endifequal %}
		     //$('.hide_add_note_section').hide();
		    $('.show_add_note_section').click(function(){
                    $('.addnote').show();
                    $(this).hide();
                    $('.hide_add_note_section').show();
                    $.post('toggleAddNoteMode/', {'addnote_mode':'on'});
                    return false;
            });
		
            $('.hide_add_note_section').click(function(){
                    $('.addnote').hide();
                    $(this).hide();
                    $('.show_add_note_section').show();
                    $.post('toggleAddNoteMode/', {'addnote_mode':'off'});
                    return false;
            });
		
            {% ifequal show_notes_mode 'on' %}	             
                    $('.show_notes_section').hide();
                    $('.hide_notes_section').show();
                    $('div#notes_section').show();				
            {% else %}
                    $('.show_notes_section').show();
                    $('.hide_notes_section').hide();
                    $('div#notes_section').hide();
		    {% endifequal %}
		
		
            $('.hide_notes_section').click(function(){
                    $('div#notes_section').hide();
             		$(this).hide();   
                    $('.show_notes_section').show();
                    $.post('toggleShowNotesMode/', {'show_notes_mode':'off'});
                    return false;
            });
		
            $('.show_notes_section').click(function(){
                    $('div#notes_section').show();	
                    $(this).hide();   	
                    $('.hide_notes_section').show();
                    $.post('toggleShowNotesMode/', {'show_notes_mode':'on'});
                    return false;
            });
		
		
		    {% ifequal show_caches_mode 'on' %}	             
                    $('.show_caches_section').hide();
                    $('.hide_caches_section').show();
                    $('div#caches_section').show();				
		    {% else %}
                    $('.show_caches_section').show();
                    $('.hide_caches_section').hide();
                    $('div#caches_section').hide();
		    {% endifequal %}
		
		
            $('.hide_caches_section').click(function(){
                    $('div#caches_section').hide();
             		$(this).hide();   
                    $('.show_caches_section').show();
                    $.post('toggleShowCachesMode/', {'show_caches_mode':'off'});
                    return false;
            });
		
            $('.show_caches_section').click(function(){
                    $('div#caches_section').show();	
                    $(this).hide();   	
                    $('.hide_caches_section').show();
                    $.post('toggleShowCachesMode/', {'show_caches_mode':'on'});
                    return false;
            });
		
		     
		        
           // $('#addnoteSubmit').click(function(){		   
            //        var form = $(this).parents('form');			
            //        $(this).load('addNote/',{'title':form.find('#id_title').val(),'desc':form.find('#id_desc').val(),'event':form.find('#id_event').val(), 
		//	                                       'vote':form.find('#id_vote').val(),'tags':form.find('#id_tags').val(),'private':form.find('#id_private').val(), 'attachment':form.find('#id_attachment').val()}); //TODO: broken pipe issue on the server side
		
          //          return false; //need this to prevent flashing the page again, e.g. requesting the same page again, which is nice in my case (although causing broken pipe -- seems avoidable if  server don't return response), but it is still refreshs the page
         //   });	

		
		
            //TODO: where to define the call back
      //      function addNoteCallback(n){
	                //alert("note added");     
      //      }			
	     
	   	
            $('div.brief_display').show();
            $('div.full_display').hide();		
		
		
            $('.yasuo').hide();
		
            $('.kuoda').click(function(){		
                    $(this).parents("li").find('div.brief_display').hide(100);
                    $(this).parents("li").find('div.full_display').show(100);
                
                    $(this).parents("li").find("div.kuoda").hide(100);
                    $(this).parents("li").find("div.yasuo").show(100);		
            });
		
            $('.yasuo').click(function(){        
                    $(this).parents("li").find('div.brief_display').show(100);
                    $(this).parents("li").find('div.full_display').hide(100);		       
                    $(this).parents("li").find("div.kuoda").show(100);
                    $(this).parents("li").find("div.yasuo").hide(100);		
            });		

        
		
            $("a:contains('(No Title)')").css({'font-weight':100,'font-size':9});	
            $("a:contains('（无标题）')").css({'font-weight':100,'font-size':9});	
            $("li.note_display:odd").css("background-color", "#FFFFFF");
            //$("li.note_display:even").css("background-color", "#E0FFFF");
            $("li.note_display:even").css("background-color", "#F5FFD6");
            //$("li.note_display:even").css("background-color", "#9DB25D");
		
        tagsAvailable = [{% for tag in tags %}"{{tag}}",{% endfor %}];

		    $("#ac_tags").tagit({
			    availableTags: tagsAvailable,
                   allowSpaces: true
            });    


            $(":input[name='sort']").change(function(){                      
                window.location.replace('?sort='+$(this).val())      
             });
             
         
             
             
             
             
                    $('.comment_submit').click(function(){  
                        var newValue = $(this).parents("#add_comment_box").find("#add_comment").val();
                        $.post('addComment/',{ 'id':$(this).parents('li').attr('note_id'), 'content':  newValue}, commentAdded ,'json');              
      
                });
                
                $('.cancel_comment_submit').click(function(){                   
                        comment_box  = $(this).parents("#add_comment_box")
                        comment_box.find("#add_comment").val('');
                        comment_box.hide();
      
                });
                
               
                
                function commentAdded(result){
                     note_id = result.note_id;
                     $("li[note_id='"+note_id+"']").find('div#comments').prepend('<div comment_id="'+result.comment_id+'">'{% block comment_display  %}+result.comment_desc+
                                                                      {% endblock %}'<span title="{% trans "remove this comment" %}" class="inline_delete_comment" id="note_delete_comment">&nbsp;&nbsp;&nbsp;</span></div>');   
                   
                    $("li[note_id='"+note_id+"']").find('div#comments').find("div[comment_id='"+result.comment_id+"']").find('span.inline_delete_comment').click(function(){	                
                        $(this).load('deleteComment/',{'comment_id':$(this).parents('div').attr('comment_id')});
                        $(this).parents("div[comment_id]").remove();
                   });
                
                    comment_box = $("li[note_id='"+note_id+"']").find('div#add_comment_box');
                    comment_box.find("#add_comment").val('')
                    //comment_box.hide();
                
                }
                
                
                 $('.add_comment_button').click(function(){                   
                        $(this).parents('li').find('#add_comment_box').show();               
      
                });
                
                
                $('span.inline_delete_comment').click(function(){	                
                    $(this).load('deleteComment/',{'comment_id':$(this).parents('div').attr('comment_id')});
                    $(this).parents("div[comment_id]").remove();
                });
                
                
               
                
                
                
                $('span.unlock').click(function(){	                   
                    $.post('makePrivate/',{'id':$(this).parents('li').attr('note_id')}, privacyChanged, 'json');                   
                });
                
                 $('span.lock').click(function(){	                   
                    $.post('makePublic/',{'id':$(this).parents('li').attr('note_id')}, privacyChanged, 'json');                   
                });
               
               
                 function privacyChanged(result){                 
                    note_id = result.note_id
                    if (result.private == 'y'){
                    //alert('is true');                          
                          $("li[note_id='"+note_id+"']").find('span.lock').show();
                          $("li[note_id='"+note_id+"']").find('span.unlock').hide();
                    }else{
                   //alert('is fale');
                          $("li[note_id='"+note_id+"']").find('span.unlock').show();
                          $("li[note_id='"+note_id+"']").find('span.lock').hide();
                    }
                     
                
                }
              
                
                
              //below is just a testing  
          //      $("input.tagit-input").keydown(function(){
  //  $(this).css("background-color","#FFFFCC");
  //});
 // $("input.tagit-input").keyup(function(){
  //  $(this).css("background-color","#D6D6FF");
 // });
                
                
               
         //firefox and chrome have different interpretation of screen.availWidth (For FF, with zooming, the screen size changes, while for chrome it doesn't.)  
        if (screen.availWidth > 1100){      
              $('#container').css({'width':'1150px'});
              $('.note_table td.note_table_td1').css({'width': '14em'});
              $('.note_table td.note_table_td2').css({'width': '25em'});
              $('.note_table td.note_table_tags').css({'width': '40em'});
              $('.snippetbook .brief_display #note_desc').css({'width': '50em'});
              $('.bookmarkbook .brief_display #note_title').css({'width': '22em'});
              $('.bookmarkbook .brief_display #note_url').css({'width': '25em'});
              $('.scrapbook .brief_display #note_url').css({'width': '15em'});
              $('.scrapbook .brief_display #note_desc').css({'width': '35em'});
        }
                

                                    
         // tagsAvailable = [{% for tag in tags %}"{{tag}}",{% endfor %}];
        $("#add_note_tags").tagit({
			    availableTags: tagsAvailable,
                   allowSpaces: true
            });    
            
        $('#add_note_tags').hide(); 
            
        $('#add_note_tags_box').hide(); 
                
      
        
      
         
        $('span.tags_edit'). click(function(){
                //alert('tags edit clicked');
                      var  editable =    $(this).parents('span.editable') ; 
                       editable.find('span.tags_text').hide();
                       //TODO: think of if better to move below into the html code and use show/hide instead of spitting out from js on the fly and remove later. Also the functions defined here can be moved out.
                        editable.prepend('<span class="tags_save">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="tags_cancel">&nbsp;&nbsp;&nbsp;&nbsp;</span>');                        
                        editable.find("#update_tags_inline_box").show();
                        
                        editable.find("#update_tags_inline").tagit({
			              availableTags: tagsAvailable,
                              allowSpaces: true,
                              
                         }); 
                         
                         $(this).hide();
                         
                         
                          $('span.tags_cancel'). click(function(){     
                                var  editable =    $(this).parents('span.editable') ;                      
                                editable.find("#update_tags_inline_box").hide();                    
                                editable.find('span.tags_save').remove();
                                editable.find('span.tags_edit').show();
                                editable.find('span.tags_text').show();
                                $(this).remove();
                                
                                 }); 
                         
                        $('span.tags_save'). click(function(){                  
                                 var selected_tags = [];	
                                 var  editable =    $(this).parents('span.editable') ;  
                                 editable.find('li.tagit-choice').each(function(){                      	                    
                                            // selected_tags = selected_tags+$(this).find(':input').val()+',';	   
                                            selected_tags.push($(this).find(':input').val());	                            
                                });	                        
                                selected_tags_str =  selected_tags.join();                            
                                $.post('updateNoteTagsInline/',{ 'id':$(this).parents('li').attr('note_id'), 'tags':  selected_tags_str}, tags_updated_inline ,'json');                  
                                //$(this).load('updateNoteInline/',{ 'id':$(this).parents('li').attr('note_id'),'note_field':'note_tags', 'content':  selected_tags_str});
                    
                    
                        });
                     
                     
                     function tags_updated_inline(result){           
                            var  editable =     $('li[note_id="'+result.note_id+'"] span.editable') ;              
                            editable.find('span.tags_cancel').remove();
                            //TODO:define variable with jquery
                             editable.find("#update_tags_inline_box").hide();                    
                            editable.find('span.tags_save').remove();
                            editable.find('span.tags_edit').show();
                            $('li[note_id='+result.note_id+'] span.tags_text').text(result.display_tags);
                            $('li[note_id='+result.note_id+'] span.tags_text').show();
                            
                            toappend = ''
                            for (var i=0;i<result.note_tags.length;i++){ 
                                 toappend = toappend+ '<span><a href="/{{profile_username}}/{{bookname}}/notes/tags/'+result.note_tags[i]+'/">'+result.note_tags[i]+'</a>,</span>';
                            }                            
                            $('li[note_id='+result.note_id+']  div.brief_display  div#note_tags').empty().append(toappend);
                    }                  
 
                         
                  
        });
        
        
        
        
        
             $("span.included_notes_edit"). click(function(){
                //alert('included_notes_edit clicked'); 
                      var  editable =    $(this).parents('span.editable') ; 
                      editable.prepend('<span class="included_notes_save">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="included_notes_cancel">&nbsp;&nbsp;&nbsp;&nbsp;</span>');                        
                      editable.find("#update_included_notes_inline_box").show();
                      $(this).hide();
                           
                       // alert('after hiding this');     
                         $("span.included_notes_cancel"). click(function(){     
                                var  editable =    $(this).parents('span.editable') ;                      
                                editable.find("#update_included_notes_inline_box").hide();                    
                                editable.find('span.included_notes_save').remove();
                                editable.find('span.included_notes_edit').show();
                                
                                $(this).remove();
                                
                                 }); 
                       //  alert('after cancel');     
                         
                         $("span.included_notes_save"). click(function(){                  
                                 var included_notes_added = $(this).parents('span.editable').find(':input').val();	
                                 //alert('included_notes_added is:'+included_notes_added);
                                 var  editable =    $(this).parents('span.editable') ;                               

                                 // alert('in save, before post');    

                             $.post('addNotesToFrame/',{ 'id':$(this).parents('li').attr('note_id'), 'included_notes_added':  included_notes_added}, included_notes_updated_inline ,'json');           
              
           
                            });            

                           // alert('after save');     

                            function included_notes_updated_inline(result){           
                                        var  editable =     $('li[note_id="'+result.note_id+'"] div.full_display  div#note_add_notes span.editable') ;         

                                        editable.find('span.included_notes_cancel').remove();
                                        //TODO:define variable with jquery
                                        editable.find("#update_included_notes_inline_box").hide();                    
                                        editable.find('span.included_notes_save').remove();
                                        editable.find('span.included_notes_edit').show();
                                        
                                        var full_display = editable.parents('div.full_display');
                                        var ul_full = full_display.find('div div#note_notes ul');                                  
                                         
                                        var ul_brief  = full_display.parents('div.framebook').find('div.brief_display').find('div#note_notes ul');
                                         //alert('ul_brief is:'+ul_brief.html());     
                                         
                                        for (var i=0;i<result.notes_added.length;i++){ 
                                        // alert('i is'+i);
                                            if (result.notes_added[i][1] == ''){
                                                title = '{% trans "(No Title)" %}';
                                            }else{
                                                title  = result.notes_added[i][1];
                                            }
                                          // alert('title:'+title);
                                            var toappend = '<div linked_note_id="'+result.notes_added[i][0]+'">'+
                                                                           '<li><img src="/site_media/img/'+result.notes_added[i][5]+'.png" title="'+result.notes_added[i][5]+'"/><a href="/{{profile_username}}/'+result.notes_added[i][4]+'/notes/note/'+result.notes_added[i][0]+'"><strong>'+title+'</strong></a>'+
                                                                                '&nbsp;&nbsp;&nbsp;'+result.notes_added[i][2]+'&nbsp;&nbsp;&nbsp;&nbsp;'+result.notes_added[i][3]+' &nbsp;&nbsp;&nbsp;&nbsp;'+
                                                                                '<span title="remove this note from the frame" class="inline_delete" id="frame_delete_note">&nbsp;&nbsp;&nbsp;</span>'+
                                                                            '</li>'+           
                                                                    '</div>';
                                             ul_full.append(toappend);
                                             ul_brief.append(toappend);
                                             
                                             //add event to the newly added included note
                                            //has to get the num out instead of using result.notes_added[i][0] directly in the event function. TODO: why?
                                             linked_note_id = result.notes_added[i][0]
                                            $('li[note_id="'+result.note_id+'"] div.full_display  div[linked_note_id="'+linked_note_id+'"]  span#frame_delete_note').click(function(){	
                                             //alert('linked_note_id:'+linked_note_id);
                                                    $.post('deleteNoteFromFrame/',{ 'linkage_id':$(this).parents('li.note_display').attr('note_id'), 'note_id':$(this).parents('div[linked_note_id]').attr('linked_note_id')});
                                                    //need to remove the one in brief_display as well
                                                    $(this).parents('div.framebook').find('div.brief_display').find('div#note_notes ul').find("div[linked_note_id='"+linked_note_id+"']").remove();                                              
                                                    $(this).parents("div[linked_note_id]").remove();                                                   
                                            });
                                            
                                             $('li[note_id="'+result.note_id+'"] div.brief_display  div[linked_note_id="'+linked_note_id+'"]  span#frame_delete_note').click(function(){	
                                                    $.post('deleteNoteFromFrame/',{ 'linkage_id':$(this).parents('li.note_display').attr('note_id'), 'note_id':$(this).parents('div[linked_note_id]').attr('linked_note_id')});                                                   
                                                     //need to remove the one in brief_display as well
                                                    $(this).parents('div.framebook').find('div.full_display').find('div#note_notes ul').find('div[linked_note_id="'+linked_note_id+'"]').remove();
                                                    $(this).parents("div[linked_note_id]").remove();                                                   
                                            });
                                           
                          
                                         } 
                            }        
            
                            // alert('after callback');     
            
                    });          
             
             
        
        
           $('span#hide_attachment').hide();	
           $('span#show_attachment'). click(function(){          
		        $('img.attachment').show();
                   $('span#hide_attachment').show();
                   $('span#show_attachment').hide();                  
            });		
           $('#hide_attachment'). click(function(){            
		        $('img.attachment').hide();
                   $('span#hide_attachment').hide();
                   $('span#show_attachment').show();
            });  
        
        
        {% block extra_ready_script %}
        {% endblock %}

        

                
                
                
    
    });
    
    
	
/*	
jQuery().ready(function(){
//below not used

jQuery('.note_display').accordion({ 
   
    header: 'div.accordion_title',
 
    active: false, 
    alwaysOpen: false, 
    animated: false, 
    autoheight: false 
});
});
*/
    


	
</script>
	
	


</head>  
<body> 


{% include "include/sites_header.html" %}


<div id="container">



{% include "include/notice_alert.html" %}






{% block site_apps_menu %}
{% endblock %}


{% block help_message_if_none %}
{% endblock %}



{% include "include/message.html" %}








 <div  id="content" class="colMS"> 
 
 <span id="toggle_side_menu" class="noPrint">
<span class="show_side_menu"><img title="{% trans "show side menu" %}" src="/site_media/img/left-arrow.jpg" class="clickable"/></span>
<span class="hide_side_menu"><img title="{% trans "hide side menu" %}" src="/site_media/img/down-arrow.jpg" class="clickable"/></span> 
</span>

<div id="content-related" class="noPrint"> 




{% comment%}
<!--
{% if user.username == profile_username %}


        <h4>{% trans "Delete" %}</h4>     
        {% if delete == 'True' %}
             <span style="font-size:15px">{% trans "Yes" %}</span><br/>
        {% else %}
            <a href="?delete=True">{% trans "Yes" %}</a><br/>        
        {% endif %}    

        {% if delete == 'False' %}
             <span style="font-size:15px">{% trans "No" %}</span><br/>
        {% else %}
             <a href="?delete=False">{% trans "No" %}</a><br/>        
        {% endif %}
       
           

        <h4>{% trans "Private" %}</h4>  
        {% if private == 'All' %}
             <span style="font-size:15px">{% trans "All" %}</span><br/>
        {% else %}
            <a href="?private=All">{% trans "All" %}</a><br/>         
        {% endif %}
        
        {% if private == 'True' %}
             <span style="font-size:15px">{% trans "Yes" %}</span><br/>
        {% else %}
            <a href="?private=True">{% trans "Yes" %}</a><br/>         
        {% endif %}
        
        {% if private == 'False' %}
             <span style="font-size:15px">{% trans "No" %}</span><br/>
        {% else %}
            <a href="?private=False">{% trans "No" %}</a><br/>              
        {% endif %} 
       
       
{% endif %}


       <h4>{% trans "Date Range" %}</h4>   

    
 
{% if date_range == 'All' %}
 <span style="font-size:15px">{% trans "Any day" %}</span><br/>
 {% else %}
<a href="?date_range=All">{% trans "Any day" %}</a><br/>   
{% endif %}

 {% if date_range == 'today' %}
 <span style="font-size:15px">{% trans "Today" %}</span><br/>
 {% else %}
<a href="?date_range=today">{% trans "Today" %}</a><br/> 	
{% endif %}

{% if date_range == 'past7days' %}
 <span style="font-size:15px">{% trans "Past 7 Days" %}</span><br/>
 {% else %}
<a href="?date_range=past7days">{% trans "Past 7 Days" %}</a><br/> 
{% endif %}

{% if date_range == 'this_month' %}
 <span style="font-size:15px">{% trans "This Month" %}</span><br/>
 {% else %}
 <a href="?date_range=this_month">{% trans "This Month" %}</a><br/> 
{% endif %}

	<a href="javascript:alert('Not implemented yet!');">{% trans "This Season" %}</a><br/>  

{% if date_range == 'this_year' %}
 <span style="font-size:15px">{% trans "This Year" %}</span><br/>
 {% else %}
<a href="?date_range=this_year">{% trans "This Year" %}</a><br/>  
{% endif %}



	<a href="javascript:alert('Not implemented yet!');">{% trans "Pick a Range" %}</a><br/>  
 


{% if bookname == 'snippetbook' %}    
            <h4>{% trans "With attachment" %}</h4>  
       {% if with_attachment == 'All' %}
             <span style="font-size:15px">{% trans "All" %}</span><br/>
        {% else %}
            <a href="?with_attachment=All">{% trans "All" %}</a><br/>   
        {% endif %}   

        {% if with_attachment == 'True' %}
             <span style="font-size:15px">{% trans "Yes" %}</span><br/>
        {% else %}
            <a href="?with_attachment=True">{% trans "Yes" %}</a><br/>
        {% endif %}  
{% endif %}                 
      
       
       
{% block linkage_filter %}
{% endblock %}

       
-->    
    
{% endcomment%}




{% block search_box %}
{% endblock %}


{% block special_side_menu %}
{% endblock %}

{% comment %}
<!--
<div class="module"> 
        <h2>{% trans "Sorting" %}</h2>  

{% if sort == 'vote' %}
 <span style="font-size:15px">{% trans "By Importance" %}</span><br/>
 {% else %}
 <a href="?sort=vote">{% trans "By Importance" %}</a><br/> 	
{% endif %}

{% if sort == 'init_date' %}
 <span style="font-size:15px">{% trans "By Creation Date" %}</span><br/>
 {% else %}
<a href="?sort=init_date">{% trans "By Creation Date" %}</a><br/>
{% endif %}

{% if sort == 'last_modi_date' %}
 <span style="font-size:15px">{% trans "By Last Modification Date" %}</span><br/>
 {% else %}
<a href="?sort=last_modi_date">{% trans "By Last Modification Date" %}</a><br/>
{% endif %}

{% if sort == 'title' %}
 <span style="font-size:15px">{% trans "By Title" %}</span><br/>
 {% else %}
<a href="?sort=title">{% trans "By Title" %}</a><br/> 	
{% endif %}

{% if sort == 'desc' %}
 <span style="font-size:15px">{% trans "By Desc" %}</span><br/>
 {% else %}
<a href="?sort=desc">{% trans "By Desc" %}</a><br/> 	
{% endif %}
    
 <h4>{% trans "Order Type" %}</h4> 
{% if order_type == 'desc' %}
 <span style="font-size:15px">{% trans "Descend" %}</span><br/>
 {% else %}
<a href="?order_type=desc">{% trans "Descend" %}</a><br/>   	
{% endif %}
{% if order_type == 'asc' %}
 <span style="font-size:15px">{% trans "Ascend" %}</span><br/>
 {% else %}
 <a href="?order_type=asc">{% trans "Ascend" %}</a><br/>    	
{% endif %}
             
      
            
</div> 


<div class="module"> 
        <h2>{% trans "Archive" %}</h2> 
	
</div> 

{% if user.username == profile_username %}
<div class="module"> 
        <h2>{% trans "Managing" %}</h2>  
       <a href="/{{profile_username}}/settings/tags/">{% trans "Manage Tags" %}</a><br/>           
       <a href="/{{profile_username}}/{{bookname}}/settings/folders/">{% trans "Manage Folders" %}</a><br/>             
</div>

{% block import_menu %}
{% endblock %}

{% endif %}


-->

<!--
<div class="module"> 
        <h2>{% trans "My Learning Groups" %}</h2>  
         <a href="javascript:alert('Not implemented yet!');">{% trans "Create a Learning Group" %}</a><br/>             
</div>
-->
{% endcomment%}

</div> 
{% comment %}
{% include "include/debug_query.html" %}
{% endcomment %}

<div id='main'>


{% block header %}
<div id="header" class="noPrint">
    <div id="branding">
        <h1 id="site-name">{% block header_title %}{% blocktrans %}Personal notes of {{profile_username}}{% endblocktrans %}{% endblock %}</h1>
    </div>

    <div class="book_tabs">
        <span class="book_tabs_item {% if bookname == 'snippetbook' %}current{% endif %}" onclick="window.location.replace('{{ book_uri_prefix }}/snippetbook/notes/')">{% trans "Snippets" %}</span>
        <span class="book_tabs_item {% if bookname == 'bookmarkbook' %}current{% endif %}" onclick="window.location.replace('{{ book_uri_prefix }}/bookmarkbook/notes/')">{% trans "Bookmarks" %}</span>
        <span class="book_tabs_item {% if bookname == 'scrapbook' %}current{% endif %}" onclick="window.location.replace('{{ book_uri_prefix }}/scrapbook/notes/')">{% trans "Scraps" %}</span>

        <span class="book_tabs_item advanced {% if bookname == 'framebook' %}current{% endif %}" onclick="window.location.replace('{{ book_uri_prefix }}/framebook/notes/')">{% trans "Frames" %}</span>
        <span class="book_tabs_item advanced {% if bookname == 'notebook' %}current{% endif %}" onclick="window.location.replace('{{ book_uri_prefix }}/notebook/notes/')">{% trans "All" %}</a></span> 
    </div>
</div>
{% endblock %}



{% block content %}




{% endblock %}
</div>


</div>





<div id="footer" class="noPrint">
{% include "include/footer.html" %}
</div>


</body> 
</html> 